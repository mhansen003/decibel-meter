<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audience Excitement Meter</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîä</text></svg>">
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --border: #1e293b;
      --text: #e2e8f0;
      --muted: #64748b;
      --green: #22c55e;
      --yellow: #eab308;
      --orange: #f97316;
      --red: #ef4444;
      --accent: #3b82f6;
      --gold: #fbbf24;
      --sidebar-w: 280px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: #0d1117;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 1.2rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .sidebar-header p {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.2rem;
    }

    .snap-count {
      background: var(--accent);
      color: #fff;
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 10px;
      font-weight: 700;
    }

    .snap-list {
      flex: 1;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      overflow-y: auto;
    }

    .snap-empty {
      color: var(--muted);
      font-size: 0.8rem;
      text-align: center;
      padding: 2rem 1rem;
      line-height: 1.5;
    }

    .snap-item {
      padding: 0.7rem 0.8rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .snap-item:hover {
      border-color: var(--accent);
      background: #161f30;
    }
    .snap-item.active {
      border-color: var(--gold);
      background: rgba(251, 191, 36, 0.06);
    }

    .snap-name {
      font-weight: 700;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .snap-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .snap-peak {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .snap-delete {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0.15rem 0.3rem;
      border-radius: 4px;
      transition: color 0.15s, background 0.15s;
    }
    .snap-delete:hover {
      color: var(--red);
      background: rgba(239, 68, 68, 0.1);
    }

    /* ‚îÄ‚îÄ Main Area ‚îÄ‚îÄ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
      min-width: 0;
    }

    header {
      text-align: center;
      padding: 1.5rem 1rem 0.8rem;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p { color: var(--muted); margin-top: 0.3rem; font-size: 0.95rem; }

    .container {
      width: 100%;
      max-width: 740px;
      padding: 0 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn-row { display: flex; gap: 0.6rem; flex-wrap: wrap; }

    #startBtn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #fff;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    }
    #startBtn:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(59, 130, 246, 0.45); }
    #startBtn:active { transform: translateY(0); }
    #startBtn.listening {
      background: linear-gradient(135deg, #dc2626, #f97316);
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
    }

    .action-btn {
      display: none;
      padding: 0.9rem 1.2rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s;
      white-space: nowrap;
    }
    .action-btn:hover { transform: translateY(-1px); }

    #logMomentBtn {
      background: linear-gradient(135deg, var(--gold), #f59e0b);
      color: #000;
    }

    #snapshotBtn {
      border: 2px solid #6366f1;
      background: transparent;
      color: #a5b4fc;
    }
    #snapshotBtn:hover { background: rgba(99, 102, 241, 0.1); }

    /* ‚îÄ‚îÄ Snapshot Detail Modal ‚îÄ‚îÄ */
    .snap-detail-overlay { display: none; }
    .snap-detail-overlay.visible { display: block; }

    .snap-detail-banner {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      margin-bottom: 0.5rem;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
    }

    /* Header with gradient */
    .snap-detail-header {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
      padding: 1.3rem 1.5rem 1rem;
      position: relative;
      overflow: hidden;
    }
    .snap-detail-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(251,191,36,0.12) 0%, transparent 70%);
      pointer-events: none;
    }

    .snap-detail-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
    }

    .snap-detail-title-wrap {
      flex: 1;
      min-width: 0;
    }

    .snap-detail-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #818cf8;
      margin-bottom: 0.2rem;
    }

    .snap-detail-title {
      font-size: 1.3rem;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .snap-detail-date {
      font-size: 0.8rem;
      color: #a5b4fc;
      margin-top: 0.15rem;
    }

    .snap-detail-close {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      cursor: pointer;
      padding: 0.4rem 0.7rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background 0.15s;
      flex-shrink: 0;
    }
    .snap-detail-close:hover { background: rgba(255,255,255,0.15); }

    /* Stats Grid */
    .snap-detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.6rem;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .snap-detail-stat {
      text-align: center;
      padding: 0.7rem 0.5rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .snap-detail-stat .val {
      font-size: 1.6rem;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      line-height: 1.1;
    }

    .snap-detail-stat .lbl {
      font-size: 0.65rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.2rem;
    }

    /* Moments Section */
    .snap-detail-section {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    .snap-detail-section:last-child { border-bottom: none; }

    .snap-section-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .snap-section-badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.6rem;
      padding: 0.1rem 0.4rem;
      border-radius: 8px;
      font-weight: 700;
    }

    .snap-moment-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0.65rem;
      font-size: 0.88rem;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      margin-bottom: 0.35rem;
      border-left: 3px solid var(--border);
      transition: background 0.15s;
    }
    .snap-moment-item:hover { background: rgba(255,255,255,0.04); }
    .snap-moment-item.top1 { border-left-color: var(--gold); }
    .snap-moment-item.top2 { border-left-color: #94a3b8; }
    .snap-moment-item.top3 { border-left-color: #d97706; }

    .snap-moment-rank {
      font-weight: 900;
      font-size: 0.85rem;
      width: 1.8rem;
      text-align: center;
      flex-shrink: 0;
    }

    .snap-moment-db {
      font-weight: 700;
      min-width: 3.5rem;
      font-variant-numeric: tabular-nums;
    }

    .snap-moment-label {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .snap-moment-time {
      color: var(--muted);
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    /* Achievements Grid */
    .snap-ach-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.4rem;
    }

    .snap-ach-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.6rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.8rem;
      transition: background 0.15s;
    }
    .snap-ach-item.unlocked {
      border-color: rgba(34, 197, 94, 0.3);
      background: rgba(34, 197, 94, 0.06);
    }
    .snap-ach-item.locked { opacity: 0.3; }

    .snap-ach-icon { font-size: 1.1rem; flex-shrink: 0; }

    .snap-ach-info { min-width: 0; }
    .snap-ach-name { font-weight: 600; font-size: 0.78rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .snap-ach-dur { font-size: 0.65rem; color: var(--gold); }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      transition: opacity 0.3s;
    }
    .card.hidden { display: none; }
    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    /* ‚îÄ‚îÄ Gauge ‚îÄ‚îÄ */
    .gauge-wrap { display: flex; flex-direction: column; align-items: center; }
    .gauge-container { position: relative; width: 320px; height: 180px; }
    canvas#gaugeCanvas { width: 320px; height: 180px; }
    .db-readout { text-align: center; margin-top: 0.5rem; }
    .db-value { font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1; transition: color 0.15s; }
    .db-unit { font-size: 1.1rem; color: var(--muted); margin-left: 0.2rem; }
    .db-label { font-size: 1rem; font-weight: 600; margin-top: 0.3rem; transition: color 0.15s; }

    /* ‚îÄ‚îÄ Peak Record ‚îÄ‚îÄ */
    .peak-record { display: flex; align-items: center; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }
    .peak-trophy { text-align: center; }
    .peak-trophy .trophy-icon { font-size: 2.8rem; line-height: 1; }
    .peak-trophy .trophy-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin-top: 0.2rem; }
    .peak-db { font-size: 4rem; font-weight: 900; font-variant-numeric: tabular-nums; color: var(--gold); line-height: 1; text-shadow: 0 0 30px rgba(251,191,36,0.4); }
    .peak-db-unit { font-size: 1.2rem; color: var(--gold); opacity: 0.7; }
    .peak-time { font-size: 0.8rem; color: var(--muted); text-align: center; margin-top: 0.5rem; }
    @keyframes newRecord { 0%{transform:scale(1)} 20%{transform:scale(1.15)} 40%{transform:scale(1)} 60%{transform:scale(1.1)} 100%{transform:scale(1)} }
    .peak-record.flash .peak-db { animation: newRecord 0.6s ease; }
    @keyframes flash-border { 0%{border-color:var(--gold);box-shadow:0 0 20px rgba(251,191,36,0.5)} 100%{border-color:var(--border);box-shadow:none} }
    .card.flash-card { animation: flash-border 1.5s ease-out; }

    /* ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ */
    .achievements { display: flex; flex-direction: column; gap: 0.5rem; }
    .ach-row { display: flex; align-items: center; gap: 0.8rem; padding: 0.65rem 0.8rem; background: #0d1321; border-radius: 10px; border-left: 4px solid var(--border); transition: border-color 0.3s, background 0.3s; }
    .ach-row.achieved { border-left-color: var(--green); background: rgba(34,197,94,0.08); }
    .ach-icon { font-size: 1.3rem; width: 2rem; text-align: center; flex-shrink: 0; }
    .ach-info { flex: 1; min-width: 0; }
    .ach-name { font-weight: 600; font-size: 0.95rem; }
    .ach-desc { font-size: 0.78rem; color: var(--muted); }
    .ach-right { text-align: right; flex-shrink: 0; }
    .ach-target { font-weight: 700; font-variant-numeric: tabular-nums; font-size: 0.95rem; }
    .ach-duration { font-size: 0.72rem; color: var(--gold); margin-top: 1px; }
    .ach-check { font-size: 1.1rem; width: 1.5rem; text-align: center; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Moments ‚îÄ‚îÄ */
    .moments-list { display: flex; flex-direction: column; gap: 0.4rem; }
    .moment-row { display: flex; align-items: center; gap: 0.7rem; padding: 0.55rem 0.7rem; background: #0d1321; border-radius: 8px; font-size: 0.88rem; }
    .moment-rank { font-weight: 800; font-size: 1rem; width: 2rem; text-align: center; }
    .moment-rank.r1 { color: var(--gold); } .moment-rank.r2 { color: #94a3b8; } .moment-rank.r3 { color: #d97706; }
    .moment-db { font-weight: 700; font-variant-numeric: tabular-nums; min-width: 3.5rem; }
    .moment-dur { color: var(--gold); font-size: 0.8rem; min-width: 3rem; }
    .moment-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .moment-time { color: var(--muted); font-size: 0.78rem; flex-shrink: 0; }
    .moment-input { flex: 1; background: #1a2234; border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 0.3rem 0.5rem; font-size: 0.85rem; font-family: inherit; }
    .moment-input:focus { outline: none; border-color: var(--accent); }
    .moment-save-btn { background: var(--accent); border: none; border-radius: 6px; color: #fff; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
    .no-moments { color: var(--muted); text-align: center; padding: 1rem; font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Bar Meter ‚îÄ‚îÄ */
    .bar-meter { display: flex; flex-direction: column; gap: 0.5rem; }
    .bar-track { height: 32px; background: #1a2234; border-radius: 8px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; width: 0%; border-radius: 8px; transition: width 0.08s linear; background: linear-gradient(90deg, var(--green) 0%, var(--yellow) 40%, var(--orange) 65%, var(--red) 85%, #dc2626 100%); }
    .bar-peak-marker { position: absolute; top: 0; width: 3px; height: 100%; background: #fff; border-radius: 2px; transition: left 0.05s linear; opacity: 0.9; }
    .bar-record-marker { position: absolute; top: 0; width: 3px; height: 100%; background: var(--gold); border-radius: 2px; opacity: 0.8; transition: left 0.2s ease; }
    .bar-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); }

    /* ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ */
    canvas#waveCanvas { width: 100%; height: 120px; border-radius: 8px; background: #0d1321; }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.6rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .stat-label { font-size: 0.75rem; color: var(--muted); margin-top: 0.15rem; }

    /* ‚îÄ‚îÄ Guide ‚îÄ‚îÄ */
    .guide-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .guide-table td { padding: 0.5rem 0.8rem; border-bottom: 1px solid var(--border); }
    .guide-table tr:last-child td { border-bottom: none; }
    .guide-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 0.5rem; vertical-align: middle; }
    .guide-db { color: var(--muted); text-align: right; white-space: nowrap; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; min-height: auto; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
      .snap-list { flex-direction: row; overflow-x: auto; overflow-y: hidden; }
      .snap-item { min-width: 200px; flex-shrink: 0; }
    }
    @media (max-width: 500px) {
      .gauge-container { width: 260px; height: 150px; }
      canvas#gaugeCanvas { width: 260px; height: 150px; }
      .db-value { font-size: 2.8rem; }
      .peak-db { font-size: 3rem; }
      .stats-grid { gap: 0.5rem; }
      .stat-value { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>üì∏ Sessions <span class="snap-count" id="snapCount">0</span></h2>
      <p>Past celebrations & events</p>
    </div>
    <div class="snap-list" id="snapList">
      <div class="snap-empty">No snapshots yet.<br>Run a session, then hit<br>"üì∏ Snapshot & New Session"<br>to save it here.</div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main">
    <header>
      <h1>üé§ Audience Excitement Meter</h1>
      <p>See which moments get the biggest crowd reaction</p>
    </header>

    <div class="container">
      <div class="btn-row">
        <button id="startBtn">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2z"/></svg>
          <span id="btnText">Start Listening</span>
        </button>
        <button id="logMomentBtn" class="action-btn">üìå Log Moment</button>
        <button id="snapshotBtn" class="action-btn">üì∏ Save &amp; Reset</button>
      </div>

      <!-- Snapshot Detail Viewer -->
      <div class="snap-detail-overlay" id="snapDetail"></div>

      <!-- Gauge -->
      <div class="card hidden" id="gaugeCard">
        <div class="card-title">Crowd Noise Level</div>
        <div class="gauge-wrap">
          <div class="gauge-container">
            <canvas id="gaugeCanvas" width="640" height="360"></canvas>
          </div>
          <div class="db-readout">
            <span class="db-value" id="dbValue">--</span><span class="db-unit">dB</span>
            <div class="db-label" id="dbLabel">Waiting...</div>
          </div>
        </div>
      </div>

      <!-- Peak Record -->
      <div class="card hidden" id="peakCard">
        <div class="card-title">Peak Excitement Record</div>
        <div class="peak-record" id="peakRecord">
          <div class="peak-trophy">
            <div class="trophy-icon">üèÜ</div>
            <div class="trophy-label">Record</div>
          </div>
          <div>
            <span class="peak-db" id="peakRecordDb">--</span><span class="peak-db-unit"> dB</span>
            <div class="peak-time" id="peakRecordTime">Make some noise!</div>
          </div>
        </div>
      </div>

      <!-- Achievements -->
      <div class="card hidden" id="achCard">
        <div class="card-title">Excitement Achievements</div>
        <div class="achievements" id="achList"></div>
      </div>

      <!-- Bar Meter -->
      <div class="card hidden" id="barCard">
        <div class="card-title">Level Meter  <span style="color:var(--gold);font-size:0.7rem;">‚ñÆ</span> = record</div>
        <div class="bar-meter">
          <div class="bar-track">
            <div class="bar-fill" id="barFill"></div>
            <div class="bar-record-marker" id="barRecordMarker" style="left:0%"></div>
            <div class="bar-peak-marker" id="barPeak"></div>
          </div>
          <div class="bar-labels">
            <span>0 dB</span><span>30</span><span>60</span><span>90</span><span>120</span><span>150 dB</span>
          </div>
        </div>
      </div>

      <!-- Waveform -->
      <div class="card hidden" id="waveCard">
        <div class="card-title">Live Waveform</div>
        <canvas id="waveCanvas" width="1400" height="240"></canvas>
      </div>

      <!-- Moments -->
      <div class="card hidden" id="momentsCard">
        <div class="card-title">Top Excitement Moments</div>
        <div class="moments-list" id="momentsList">
          <div class="no-moments">Hit "üìå Log Moment" during peaks to capture what the audience is reacting to!</div>
        </div>
      </div>

      <!-- Stats -->
      <div class="card hidden" id="statsCard">
        <div class="card-title">Session Statistics</div>
        <div class="stats-grid">
          <div class="stat-item"><div class="stat-value" id="statMin">--</div><div class="stat-label">Min dB</div></div>
          <div class="stat-item"><div class="stat-value" id="statAvg">--</div><div class="stat-label">Avg dB</div></div>
          <div class="stat-item"><div class="stat-value" id="statMax">--</div><div class="stat-label">Max dB</div></div>
        </div>
      </div>

      <!-- Guide -->
      <div class="card">
        <div class="card-title">Excitement Scale</div>
        <table class="guide-table">
          <tr><td><span class="guide-dot" style="background:var(--green)"></span>Calm / Quiet</td><td class="guide-db">0 ‚Äì 30 dB</td></tr>
          <tr><td><span class="guide-dot" style="background:var(--green)"></span>Light Chatter</td><td class="guide-db">30 ‚Äì 60 dB</td></tr>
          <tr><td><span class="guide-dot" style="background:var(--yellow)"></span>Engaged Crowd</td><td class="guide-db">60 ‚Äì 80 dB</td></tr>
          <tr><td><span class="guide-dot" style="background:var(--orange)"></span>Excited!</td><td class="guide-db">80 ‚Äì 100 dB</td></tr>
          <tr><td><span class="guide-dot" style="background:var(--red)"></span>Going Wild!</td><td class="guide-db">100 ‚Äì 120 dB</td></tr>
          <tr><td><span class="guide-dot" style="background:#dc2626"></span>OFF THE CHARTS!</td><td class="guide-db">120 ‚Äì 150 dB</td></tr>
        </table>
      </div>
    </div>
  </div>

  <script>
    const MAX_DB = 150;

    // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
    const startBtn=document.getElementById('startBtn'), logMomentBtn=document.getElementById('logMomentBtn');
    const snapshotBtn=document.getElementById('snapshotBtn'), btnText=document.getElementById('btnText');
    const gaugeCard=document.getElementById('gaugeCard'), peakCard=document.getElementById('peakCard');
    const achCard=document.getElementById('achCard'), barCard=document.getElementById('barCard');
    const waveCard=document.getElementById('waveCard'), momentsCard=document.getElementById('momentsCard');
    const statsCard=document.getElementById('statsCard');
    const dbValue=document.getElementById('dbValue'), dbLabel=document.getElementById('dbLabel');
    const barFill=document.getElementById('barFill'), barPeak=document.getElementById('barPeak');
    const barRecordMarker=document.getElementById('barRecordMarker');
    const statMin=document.getElementById('statMin'), statAvg=document.getElementById('statAvg'), statMax=document.getElementById('statMax');
    const peakRecordDb=document.getElementById('peakRecordDb'), peakRecordTime=document.getElementById('peakRecordTime');
    const peakRecord=document.getElementById('peakRecord');
    const achList=document.getElementById('achList'), momentsList=document.getElementById('momentsList');
    const snapListEl=document.getElementById('snapList'), snapCountEl=document.getElementById('snapCount');
    const snapDetail=document.getElementById('snapDetail');
    const gaugeCanvas=document.getElementById('gaugeCanvas'), gaugeCtx=gaugeCanvas.getContext('2d');
    const waveCanvas=document.getElementById('waveCanvas'), waveCtx=waveCanvas.getContext('2d');

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let audioCtx, analyser, source, stream, listening=false, animId;
    let peakDb=0, peakDecay=0, currentDb=0;
    let sessionMin=Infinity, sessionMax=-Infinity, sessionSum=0, sessionCount=0, sessionStartTime=null;
    let allTimeRecord=parseInt(localStorage.getItem('db_record')||'0',10);
    let allTimeRecordTime=localStorage.getItem('db_record_time')||'';
    let moments=JSON.parse(localStorage.getItem('db_moments')||'[]');
    let snapshots=JSON.parse(localStorage.getItem('db_snapshots')||'[]');

    const achievements=[
      {db:30,icon:'üòä',name:'Polite Interest',desc:'Audience is paying attention'},
      {db:50,icon:'üëè',name:'Solid Applause',desc:'Genuine clapping & chatter'},
      {db:70,icon:'üéâ',name:'Crowd Buzz',desc:'Room is alive with energy'},
      {db:85,icon:'üî•',name:'On Fire!',desc:'People are really into it'},
      {db:100,icon:'ü§©',name:'Standing Ovation',desc:'The crowd is losing it'},
      {db:110,icon:'üì£',name:'Stadium Roar',desc:'Deafening cheers'},
      {db:120,icon:'üö®',name:'Ear Splitting',desc:'Threshold of pain reached'},
      {db:130,icon:'‚úàÔ∏è',name:'Jet Engine',desc:'Louder than a takeoff'},
      {db:140,icon:'üöÄ',name:'Rocket Launch',desc:'Beyond belief'},
      {db:150,icon:'üí•',name:'LEGENDARY',desc:'Maximum crowd excitement!'},
    ];

    let achDurations=JSON.parse(localStorage.getItem('db_ach_durations')||'{}');
    let achMaxStreaks=JSON.parse(localStorage.getItem('db_ach_max_streaks')||'{}');
    let achCurrentStreaks={};
    const FRAME_DUR=1/60;

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function getLevel(db){
      if(db<30) return{color:'var(--green)',label:'Calm'};
      if(db<60) return{color:'var(--green)',label:'Light Chatter'};
      if(db<80) return{color:'var(--yellow)',label:'Engaged'};
      if(db<100) return{color:'var(--orange)',label:'Excited!'};
      if(db<120) return{color:'var(--red)',label:'Going Wild!'};
      return{color:'#dc2626',label:'OFF THE CHARTS!'};
    }
    function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
    function timeStr(){return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
    function dateStr(){return new Date().toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});}
    function fmtDur(sec){
      if(sec<1) return '<1s';
      if(sec<60) return Math.round(sec)+'s';
      const m=Math.floor(sec/60),s=Math.round(sec%60);
      return m+'m '+s+'s';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SIDEBAR ‚Äî Snapshot Management
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function renderSnapshots() {
      snapCountEl.textContent = snapshots.length;
      if (snapshots.length === 0) {
        snapListEl.innerHTML = '<div class="snap-empty">No snapshots yet.<br>Run a session, then hit<br>"üì∏ Save & Reset"<br>to save it here.</div>';
        return;
      }
      snapListEl.innerHTML = '';
      snapshots.forEach((s, i) => {
        const item = document.createElement('div');
        item.className = 'snap-item';
        item.dataset.idx = i;
        const level = getLevel(s.record.db);
        item.innerHTML = `
          <div class="snap-name">${s.name}</div>
          <div class="snap-meta">
            <span class="snap-peak" style="color:${level.color}">üèÜ ${s.record.db} dB</span>
            <span>${s.date || ''}</span>
            <button class="snap-delete" data-idx="${i}" title="Delete snapshot">‚úï</button>
          </div>
        `;
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('snap-delete')) return;
          showSnapshotDetail(i);
          document.querySelectorAll('.snap-item').forEach(el => el.classList.remove('active'));
          item.classList.add('active');
        });
        snapListEl.appendChild(item);
      });

      // Delete handlers
      snapListEl.querySelectorAll('.snap-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.dataset.idx, 10);
          if (confirm('Delete "' + snapshots[idx].name + '"?')) {
            snapshots.splice(idx, 1);
            localStorage.setItem('db_snapshots', JSON.stringify(snapshots));
            renderSnapshots();
            snapDetail.classList.remove('visible');
            snapDetail.innerHTML = '';
          }
        });
      });
    }

    function showSnapshotDetail(idx) {
      const s = snapshots[idx];
      const level = getLevel(s.record.db);
      const achUnlocked = s.achievements ? s.achievements.filter(a => a.achieved).length : 0;

      // Moments HTML
      let momentsHtml = '';
      if (s.moments && s.moments.length > 0) {
        const sorted = [...s.moments].sort((a,b) => b.db - a.db);
        momentsHtml = `
          <div class="snap-detail-section">
            <div class="snap-section-title">Logged Moments <span class="snap-section-badge">${sorted.length}</span></div>
            ${sorted.map((m, i) => {
              const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`;
              const topClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
              return `<div class="snap-moment-item ${topClass}">
                <span class="snap-moment-rank">${medal}</span>
                <span class="snap-moment-db" style="color:${getLevel(m.db).color}">${m.db} dB</span>
                <span class="snap-moment-label">${m.label || '(unnamed)'}</span>
                <span class="snap-moment-time">${m.time}</span>
              </div>`;
            }).join('')}
          </div>
        `;
      }

      // Achievements HTML
      let achHtml = '';
      if (s.achievements) {
        achHtml = `
          <div class="snap-detail-section">
            <div class="snap-section-title">Achievements <span class="snap-section-badge">${achUnlocked}/${s.achievements.length}</span></div>
            <div class="snap-ach-grid">
              ${[...s.achievements].reverse().map(a => {
                const def = achievements.find(x => x.db === a.db);
                return `<div class="snap-ach-item ${a.achieved ? 'unlocked' : 'locked'}">
                  <span class="snap-ach-icon">${def?.icon || ''}</span>
                  <div class="snap-ach-info">
                    <div class="snap-ach-name">${a.name}</div>
                    ${a.achieved && a.totalDuration ? `<div class="snap-ach-dur">${fmtDur(a.totalDuration)} total</div>` : ''}
                  </div>
                </div>`;
              }).join('')}
            </div>
          </div>
        `;
      }

      snapDetail.innerHTML = `
        <div class="snap-detail-banner">
          <div class="snap-detail-header">
            <div class="snap-detail-top">
              <div class="snap-detail-title-wrap">
                <div class="snap-detail-label">Saved Session</div>
                <div class="snap-detail-title">${s.name}</div>
                ${s.date ? `<div class="snap-detail-date">üìÖ ${s.date}</div>` : ''}
              </div>
              <button class="snap-detail-close" id="closeSnapDetail">‚úï Close</button>
            </div>
          </div>
          <div class="snap-detail-stats">
            <div class="snap-detail-stat">
              <div class="val" style="color:${level.color}">${s.record.db}</div>
              <div class="lbl">üèÜ Peak dB</div>
            </div>
            ${s.sessionStats?.avg != null ? `<div class="snap-detail-stat"><div class="val">${s.sessionStats.avg}</div><div class="lbl">üìä Avg dB</div></div>` : ''}
            ${s.sessionStats?.min != null ? `<div class="snap-detail-stat"><div class="val">${s.sessionStats.min}</div><div class="lbl">üìâ Min dB</div></div>` : ''}
            ${s.moments ? `<div class="snap-detail-stat"><div class="val">${s.moments.length}</div><div class="lbl">üìå Moments</div></div>` : ''}
            <div class="snap-detail-stat">
              <div class="val">${achUnlocked}<span style="font-size:0.8rem;color:var(--muted)">/${s.achievements?.length || 10}</span></div>
              <div class="lbl">‚úÖ Unlocked</div>
            </div>
          </div>
          ${momentsHtml}
          ${achHtml}
        </div>
      `;
      snapDetail.classList.add('visible');
      document.getElementById('closeSnapDetail').addEventListener('click', () => {
        snapDetail.classList.remove('visible');
        snapDetail.innerHTML = '';
        document.querySelectorAll('.snap-item').forEach(el => el.classList.remove('active'));
      });
    }

    // ‚îÄ‚îÄ Render Achievements (biggest first) ‚îÄ‚îÄ
    function renderAchievements(){
      achList.innerHTML='';
      [...achievements].reverse().forEach(a=>{
        const hit=allTimeRecord>=a.db;
        const totalDur=achDurations[a.db]||0;
        const maxStreak=achMaxStreaks[a.db]||0;
        const row=document.createElement('div');
        row.className='ach-row'+(hit?' achieved':'');
        row.innerHTML=`
          <div class="ach-icon">${a.icon}</div>
          <div class="ach-info"><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div></div>
          <div class="ach-right">
            <div class="ach-target">${a.db} dB</div>
            ${hit?`<div class="ach-duration">Total: ${fmtDur(totalDur)} | Best: ${fmtDur(maxStreak)}</div>`:''}
          </div>
          <div class="ach-check">${hit?'‚úÖ':'‚¨ú'}</div>`;
        achList.appendChild(row);
      });
    }

    // ‚îÄ‚îÄ Render Moments ‚îÄ‚îÄ
    function renderMoments(){
      momentsList.innerHTML='';
      if(!moments.length){momentsList.innerHTML='<div class="no-moments">Hit "üìå Log Moment" during peaks to capture what the audience is reacting to!</div>';return;}
      const sorted=[...moments].sort((a,b)=>b.db-a.db);
      sorted.forEach((m,i)=>{
        const rc=i===0?'r1':i===1?'r2':i===2?'r3':'';
        const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`;
        const lv=getLevel(m.db);
        const row=document.createElement('div');
        row.className='moment-row';
        if(m.editing){
          row.innerHTML=`<span class="moment-rank ${rc}">${medal}</span><span class="moment-db" style="color:${lv.color}">${m.db} dB</span>
            <input class="moment-input" type="text" placeholder="What happened?" value="${m.label||''}" data-idx="${moments.indexOf(m)}"/>
            <button class="moment-save-btn" data-idx="${moments.indexOf(m)}">Save</button>
            <span class="moment-time">${m.time}</span>`;
        } else {
          row.innerHTML=`<span class="moment-rank ${rc}">${medal}</span><span class="moment-db" style="color:${lv.color}">${m.db} dB</span>
            <span class="moment-dur">${fmtDur(m.duration||0)}</span>
            <span class="moment-label">${m.label||'(unnamed moment)'}</span>
            <span class="moment-time">${m.time}</span>`;
        }
        momentsList.appendChild(row);
      });
      momentsList.querySelectorAll('.moment-save-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const idx=parseInt(btn.dataset.idx,10);
          const input=momentsList.querySelector(`input[data-idx="${idx}"]`);
          if(input){moments[idx].label=input.value||'(unnamed moment)';moments[idx].editing=false;localStorage.setItem('db_moments',JSON.stringify(moments));renderMoments();}
        });
      });
      momentsList.querySelectorAll('.moment-input').forEach(input=>{
        input.addEventListener('keydown',e=>{
          if(e.key==='Enter'){const idx=parseInt(input.dataset.idx,10);moments[idx].label=input.value||'(unnamed moment)';moments[idx].editing=false;localStorage.setItem('db_moments',JSON.stringify(moments));renderMoments();}
        });
      });
    }

    // ‚îÄ‚îÄ Log Moment ‚îÄ‚îÄ
    logMomentBtn.addEventListener('click',()=>{
      if(!listening)return;
      moments.push({db:currentDb,time:timeStr(),elapsed:sessionStartTime?Math.round((Date.now()-sessionStartTime)/1000):0,duration:achCurrentStreaks[Math.floor(currentDb/10)*10]||0,label:'',editing:true});
      localStorage.setItem('db_moments',JSON.stringify(moments));
      renderMoments();
      setTimeout(()=>{const inputs=momentsList.querySelectorAll('.moment-input');if(inputs.length)inputs[inputs.length-1].focus();},50);
    });

    // ‚îÄ‚îÄ Records & Durations ‚îÄ‚îÄ
    function checkRecord(db){
      if(db<=0)return;
      if(db>allTimeRecord){allTimeRecord=db;allTimeRecordTime=timeStr();localStorage.setItem('db_record',String(allTimeRecord));localStorage.setItem('db_record_time',allTimeRecordTime);peakRecord.classList.remove('flash');void peakRecord.offsetWidth;peakRecord.classList.add('flash');peakCard.classList.remove('flash-card');void peakCard.offsetWidth;peakCard.classList.add('flash-card');renderAchievements();}
      peakRecordDb.textContent=allTimeRecord;peakRecordTime.textContent=allTimeRecordTime?`Set at ${allTimeRecordTime}`:'Make some noise!';barRecordMarker.style.left=((allTimeRecord/MAX_DB)*100)+'%';
    }

    function updateAchDurations(db){
      achievements.forEach(a=>{if(db>=a.db){achDurations[a.db]=(achDurations[a.db]||0)+FRAME_DUR;achCurrentStreaks[a.db]=(achCurrentStreaks[a.db]||0)+FRAME_DUR;if((achCurrentStreaks[a.db]||0)>(achMaxStreaks[a.db]||0))achMaxStreaks[a.db]=achCurrentStreaks[a.db];}else{achCurrentStreaks[a.db]=0;}});
      if(sessionCount%120===0){localStorage.setItem('db_ach_durations',JSON.stringify(achDurations));localStorage.setItem('db_ach_max_streaks',JSON.stringify(achMaxStreaks));}
    }

    // ‚îÄ‚îÄ Gauge ‚îÄ‚îÄ
    function drawGauge(db){
      const W=gaugeCanvas.width,H=gaugeCanvas.height,cx=W/2,cy=H-20,radius=Math.min(cx,cy)-30;
      gaugeCtx.clearRect(0,0,W,H);
      const sa=Math.PI,segs=[{end:.20,color:'#22c55e'},{end:.40,color:'#84cc16'},{end:.53,color:'#eab308'},{end:.67,color:'#f97316'},{end:.80,color:'#ef4444'},{end:1,color:'#dc2626'}];
      let pf=0;segs.forEach(s=>{gaugeCtx.beginPath();gaugeCtx.arc(cx,cy,radius,sa+pf*Math.PI,sa+s.end*Math.PI);gaugeCtx.lineWidth=22;gaugeCtx.strokeStyle=s.color;gaugeCtx.lineCap='butt';gaugeCtx.globalAlpha=.25;gaugeCtx.stroke();pf=s.end;});
      const fr=clamp(db/MAX_DB,0,1);pf=0;segs.forEach(s=>{if(fr>pf){gaugeCtx.beginPath();gaugeCtx.arc(cx,cy,radius,sa+pf*Math.PI,sa+Math.min(fr,s.end)*Math.PI);gaugeCtx.lineWidth=22;gaugeCtx.strokeStyle=s.color;gaugeCtx.globalAlpha=1;gaugeCtx.stroke();}pf=s.end;});
      gaugeCtx.globalAlpha=1;
      for(let i=0;i<=15;i++){const a=sa+(i/15)*Math.PI,maj=i%3===0,ir=radius-(maj?32:26),or=radius-16;gaugeCtx.beginPath();gaugeCtx.moveTo(cx+ir*Math.cos(a),cy+ir*Math.sin(a));gaugeCtx.lineTo(cx+or*Math.cos(a),cy+or*Math.sin(a));gaugeCtx.strokeStyle=maj?'#94a3b8':'#475569';gaugeCtx.lineWidth=maj?2:1;gaugeCtx.stroke();if(maj){const lr=ir-14;gaugeCtx.fillStyle='#94a3b8';gaugeCtx.font='600 13px system-ui';gaugeCtx.textAlign='center';gaugeCtx.textBaseline='middle';gaugeCtx.fillText(String(i*10),cx+lr*Math.cos(a),cy+lr*Math.sin(a));}}
      if(allTimeRecord>0){const ra=sa+(allTimeRecord/MAX_DB)*Math.PI;gaugeCtx.beginPath();gaugeCtx.arc(cx+(radius+2)*Math.cos(ra),cy+(radius+2)*Math.sin(ra),5,0,Math.PI*2);gaugeCtx.fillStyle='#fbbf24';gaugeCtx.shadowColor='rgba(251,191,36,0.6)';gaugeCtx.shadowBlur=10;gaugeCtx.fill();gaugeCtx.shadowBlur=0;}
      const na=sa+fr*Math.PI;gaugeCtx.save();gaugeCtx.translate(cx,cy);gaugeCtx.rotate(na);gaugeCtx.beginPath();gaugeCtx.moveTo(0,-3);gaugeCtx.lineTo(radius-38,0);gaugeCtx.lineTo(0,3);gaugeCtx.closePath();gaugeCtx.fillStyle='#f8fafc';gaugeCtx.shadowColor='rgba(255,255,255,0.3)';gaugeCtx.shadowBlur=8;gaugeCtx.fill();gaugeCtx.restore();
      gaugeCtx.beginPath();gaugeCtx.arc(cx,cy,7,0,Math.PI*2);gaugeCtx.fillStyle='#e2e8f0';gaugeCtx.fill();
    }

    // ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ
    function drawWaveform(d){
      const W=waveCanvas.width,H=waveCanvas.height;waveCtx.clearRect(0,0,W,H);
      const g=waveCtx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#3b82f6');g.addColorStop(.5,'#a78bfa');g.addColorStop(1,'#3b82f6');
      waveCtx.beginPath();const sw=W/d.length;let x=0;for(let i=0;i<d.length;i++){const y=(d[i]/128*H)/2;i===0?waveCtx.moveTo(x,y):waveCtx.lineTo(x,y);x+=sw;}
      waveCtx.strokeStyle=g;waveCtx.lineWidth=2;waveCtx.stroke();waveCtx.globalAlpha=.3;waveCtx.stroke();waveCtx.globalAlpha=1;
    }

    // ‚îÄ‚îÄ Main Loop ‚îÄ‚îÄ
    function loop(){
      if(!listening)return;
      const d=new Float32Array(analyser.fftSize);analyser.getFloatTimeDomainData(d);
      let sq=0;for(let i=0;i<d.length;i++)sq+=d[i]*d[i];
      const rms=Math.sqrt(sq/d.length);let db=rms>0.000001?20*Math.log10(rms)+110:0;db=clamp(Math.round(db),0,MAX_DB);currentDb=db;
      if(db>peakDb){peakDb=db;peakDecay=0;}else{peakDecay++;if(peakDecay>40)peakDb=Math.max(peakDb-.5,db);}
      if(db>0){sessionMin=Math.min(sessionMin,db);sessionMax=Math.max(sessionMax,db);sessionSum+=db;sessionCount++;}
      checkRecord(db);updateAchDurations(db);
      if(sessionCount%60===0)renderAchievements();
      const lv=getLevel(db);dbValue.textContent=db;dbValue.style.color=lv.color;dbLabel.textContent=lv.label;dbLabel.style.color=lv.color;
      barFill.style.width=(db/MAX_DB*100)+'%';barPeak.style.left=(peakDb/MAX_DB*100)+'%';
      drawGauge(db);
      const wd=new Uint8Array(analyser.fftSize);analyser.getByteTimeDomainData(wd);drawWaveform(wd);
      if(sessionCount>0){statMin.textContent=sessionMin===Infinity?'--':sessionMin;statAvg.textContent=Math.round(sessionSum/sessionCount);statMax.textContent=sessionMax===-Infinity?'--':sessionMax;}
      animId=requestAnimationFrame(loop);
    }

    // ‚îÄ‚îÄ Start / Stop ‚îÄ‚îÄ
    async function startListening(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
        audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')await audioCtx.resume();
        analyser=audioCtx.createAnalyser();analyser.fftSize=4096;analyser.smoothingTimeConstant=.2;analyser.minDecibels=-127;analyser.maxDecibels=0;
        source=audioCtx.createMediaStreamSource(stream);source.connect(analyser);
        listening=true;sessionStartTime=Date.now();
        startBtn.classList.add('listening');btnText.textContent='Stop Listening';
        logMomentBtn.style.display='block';snapshotBtn.style.display='block';
        [gaugeCard,peakCard,achCard,barCard,waveCard,momentsCard,statsCard].forEach(c=>c.classList.remove('hidden'));
        sessionMin=Infinity;sessionMax=-Infinity;sessionSum=0;sessionCount=0;peakDb=0;achCurrentStreaks={};
        renderAchievements();renderMoments();checkRecord(0);loop();
      }catch(err){alert('Microphone access is required.\n\n'+err.message);}
    }

    function stopListening(){
      listening=false;cancelAnimationFrame(animId);
      if(source)source.disconnect();if(stream)stream.getTracks().forEach(t=>t.stop());if(audioCtx)audioCtx.close();
      startBtn.classList.remove('listening');btnText.textContent='Start Listening';
      logMomentBtn.style.display='none';snapshotBtn.style.display='none';
      localStorage.setItem('db_ach_durations',JSON.stringify(achDurations));
      localStorage.setItem('db_ach_max_streaks',JSON.stringify(achMaxStreaks));
      renderAchievements();
    }

    startBtn.addEventListener('click',()=>{if(listening)stopListening();else startListening();});

    // ‚îÄ‚îÄ Snapshot & Clear ‚îÄ‚îÄ
    snapshotBtn.addEventListener('click',()=>{
      const name=prompt('üì∏ Name this session:\n(e.g. "Product Launch Demo", "Q1 All-Hands")');
      if(name===null)return; // cancelled
      const sessionName=name.trim()||'Unnamed Session';

      // Build snapshot
      const snapshot={
        name: sessionName,
        date: dateStr(),
        exportedAt: new Date().toISOString(),
        record:{db:allTimeRecord,time:allTimeRecordTime},
        achievements:achievements.map(a=>({name:a.name,db:a.db,achieved:allTimeRecord>=a.db,totalDuration:achDurations[a.db]||0,bestStreak:achMaxStreaks[a.db]||0})),
        moments:moments.map(m=>({db:m.db,time:m.time,label:m.label,duration:m.duration||0})),
        sessionStats:{min:sessionMin===Infinity?null:sessionMin,avg:sessionCount>0?Math.round(sessionSum/sessionCount):null,max:sessionMax===-Infinity?null:sessionMax},
      };

      // Save to sidebar
      snapshots.unshift(snapshot);
      localStorage.setItem('db_snapshots',JSON.stringify(snapshots));
      renderSnapshots();

      // Clear all live data
      allTimeRecord=0;allTimeRecordTime='';moments=[];achDurations={};achMaxStreaks={};achCurrentStreaks={};
      localStorage.removeItem('db_record');localStorage.removeItem('db_record_time');localStorage.removeItem('db_moments');
      localStorage.removeItem('db_ach_durations');localStorage.removeItem('db_ach_max_streaks');

      sessionMin=Infinity;sessionMax=-Infinity;sessionSum=0;sessionCount=0;peakDb=0;
      peakRecordDb.textContent='--';peakRecordTime.textContent='Make some noise!';barRecordMarker.style.left='0%';
      statMin.textContent='--';statAvg.textContent='--';statMax.textContent='--';
      renderAchievements();renderMoments();
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    renderSnapshots();
  </script>
</body>
</html>
