<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audience Excitement Meter</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîä</text></svg>">
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --border: #1e293b;
      --text: #e2e8f0;
      --muted: #64748b;
      --green: #22c55e;
      --yellow: #eab308;
      --orange: #f97316;
      --red: #ef4444;
      --accent: #3b82f6;
      --gold: #fbbf24;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    header {
      text-align: center;
      padding: 2rem 1rem 1rem;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: var(--muted);
      margin-top: 0.3rem;
      font-size: 0.95rem;
    }

    .container {
      width: 100%;
      max-width: 740px;
      padding: 0 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn-row {
      display: flex;
      gap: 0.6rem;
    }

    #startBtn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: #fff;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    }
    #startBtn:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(59, 130, 246, 0.45); }
    #startBtn:active { transform: translateY(0); }
    #startBtn.listening {
      background: linear-gradient(135deg, #dc2626, #f97316);
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
    }

    #logMomentBtn {
      display: none;
      padding: 0.9rem 1.2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--gold), #f59e0b);
      color: #000;
      transition: transform 0.15s;
      white-space: nowrap;
    }
    #logMomentBtn:hover { transform: translateY(-1px); }

    #snapshotBtn {
      display: none;
      padding: 0.9rem 2rem;
      border: 2px solid #6366f1;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #a5b4fc;
      transition: transform 0.15s, background 0.15s;
      white-space: nowrap;
    }
    #snapshotBtn:hover { transform: translateY(-1px); background: rgba(99, 102, 241, 0.1); }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      transition: opacity 0.3s;
    }
    .card.hidden { display: none; }

    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    /* ‚îÄ‚îÄ Gauge ‚îÄ‚îÄ */
    .gauge-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gauge-container {
      position: relative;
      width: 320px;
      height: 180px;
    }

    canvas#gaugeCanvas { width: 320px; height: 180px; }

    .db-readout { text-align: center; margin-top: 0.5rem; }

    .db-value {
      font-size: 3.5rem;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      transition: color 0.15s;
    }

    .db-unit { font-size: 1.1rem; color: var(--muted); margin-left: 0.2rem; }

    .db-label {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 0.3rem;
      transition: color 0.15s;
    }

    /* ‚îÄ‚îÄ Peak Record ‚îÄ‚îÄ */
    .peak-record {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .peak-trophy { text-align: center; }
    .peak-trophy .trophy-icon { font-size: 2.8rem; line-height: 1; }
    .peak-trophy .trophy-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin-top: 0.2rem; }

    .peak-db {
      font-size: 4rem; font-weight: 900; font-variant-numeric: tabular-nums;
      color: var(--gold); line-height: 1;
      text-shadow: 0 0 30px rgba(251, 191, 36, 0.4);
    }
    .peak-db-unit { font-size: 1.2rem; color: var(--gold); opacity: 0.7; }
    .peak-time { font-size: 0.8rem; color: var(--muted); text-align: center; margin-top: 0.5rem; }

    @keyframes newRecord {
      0% { transform: scale(1); }
      20% { transform: scale(1.15); }
      40% { transform: scale(1); }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .peak-record.flash .peak-db { animation: newRecord 0.6s ease; }
    @keyframes flash-border {
      0% { border-color: var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
      100% { border-color: var(--border); box-shadow: none; }
    }
    .card.flash-card { animation: flash-border 1.5s ease-out; }

    /* ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ */
    .achievements {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .ach-row {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.65rem 0.8rem;
      background: #0d1321;
      border-radius: 10px;
      border-left: 4px solid var(--border);
      transition: border-color 0.3s, background 0.3s;
    }
    .ach-row.achieved {
      border-left-color: var(--green);
      background: rgba(34, 197, 94, 0.08);
    }

    .ach-icon { font-size: 1.3rem; width: 2rem; text-align: center; flex-shrink: 0; }

    .ach-info { flex: 1; min-width: 0; }
    .ach-name { font-weight: 600; font-size: 0.95rem; }
    .ach-desc { font-size: 0.78rem; color: var(--muted); }

    .ach-right {
      text-align: right;
      flex-shrink: 0;
    }
    .ach-target { font-weight: 700; font-variant-numeric: tabular-nums; font-size: 0.95rem; }
    .ach-duration { font-size: 0.72rem; color: var(--gold); margin-top: 1px; }
    .ach-check { font-size: 1.1rem; width: 1.5rem; text-align: center; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Excitement Moments Log ‚îÄ‚îÄ */
    .moments-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .moment-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      padding: 0.55rem 0.7rem;
      background: #0d1321;
      border-radius: 8px;
      font-size: 0.88rem;
    }

    .moment-rank { font-weight: 800; font-size: 1rem; width: 2rem; text-align: center; }
    .moment-rank.r1 { color: var(--gold); }
    .moment-rank.r2 { color: #94a3b8; }
    .moment-rank.r3 { color: #d97706; }

    .moment-db { font-weight: 700; font-variant-numeric: tabular-nums; min-width: 3.5rem; }
    .moment-dur { color: var(--gold); font-size: 0.8rem; min-width: 3rem; }
    .moment-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .moment-time { color: var(--muted); font-size: 0.78rem; flex-shrink: 0; }

    .moment-input {
      flex: 1;
      background: #1a2234;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 0.3rem 0.5rem;
      font-size: 0.85rem;
      font-family: inherit;
    }
    .moment-input:focus { outline: none; border-color: var(--accent); }

    .moment-save-btn {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .no-moments { color: var(--muted); text-align: center; padding: 1rem; font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Bar Meter ‚îÄ‚îÄ */
    .bar-meter { display: flex; flex-direction: column; gap: 0.5rem; }

    .bar-track {
      height: 32px; background: #1a2234; border-radius: 8px;
      overflow: hidden; position: relative;
    }

    .bar-fill {
      height: 100%; width: 0%; border-radius: 8px;
      transition: width 0.08s linear;
      background: linear-gradient(90deg, var(--green) 0%, var(--yellow) 40%, var(--orange) 65%, var(--red) 85%, #dc2626 100%);
    }

    .bar-peak-marker {
      position: absolute; top: 0; width: 3px; height: 100%;
      background: #fff; border-radius: 2px;
      transition: left 0.05s linear; opacity: 0.9;
    }

    .bar-record-marker {
      position: absolute; top: 0; width: 3px; height: 100%;
      background: var(--gold); border-radius: 2px; opacity: 0.8;
      transition: left 0.2s ease;
    }

    .bar-labels {
      display: flex; justify-content: space-between;
      font-size: 0.75rem; color: var(--muted);
    }

    /* ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ */
    canvas#waveCanvas {
      width: 100%; height: 120px; border-radius: 8px; background: #0d1321;
    }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.6rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .stat-label { font-size: 0.75rem; color: var(--muted); margin-top: 0.15rem; }

    /* ‚îÄ‚îÄ Guide ‚îÄ‚îÄ */
    .guide-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .guide-table td { padding: 0.5rem 0.8rem; border-bottom: 1px solid var(--border); }
    .guide-table tr:last-child td { border-bottom: none; }
    .guide-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 0.5rem; vertical-align: middle; }
    .guide-db { color: var(--muted); text-align: right; white-space: nowrap; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 500px) {
      .gauge-container { width: 260px; height: 150px; }
      canvas#gaugeCanvas { width: 260px; height: 150px; }
      .db-value { font-size: 2.8rem; }
      .peak-db { font-size: 3rem; }
      .stats-grid { gap: 0.5rem; }
      .stat-value { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üé§ Audience Excitement Meter</h1>
    <p>See which moments get the biggest crowd reaction</p>
  </header>

  <div class="container">
    <div class="btn-row">
      <button id="startBtn">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2z"/></svg>
        <span id="btnText">Start Listening</span>
      </button>
      <button id="logMomentBtn">üìå Log Moment</button>
    </div>
    <button id="snapshotBtn">üì∏ Snapshot &amp; New Session</button>

    <!-- Gauge -->
    <div class="card hidden" id="gaugeCard">
      <div class="card-title">Crowd Noise Level</div>
      <div class="gauge-wrap">
        <div class="gauge-container">
          <canvas id="gaugeCanvas" width="640" height="360"></canvas>
        </div>
        <div class="db-readout">
          <span class="db-value" id="dbValue">--</span><span class="db-unit">dB</span>
          <div class="db-label" id="dbLabel">Waiting...</div>
        </div>
      </div>
    </div>

    <!-- Peak Record -->
    <div class="card hidden" id="peakCard">
      <div class="card-title">Peak Excitement Record</div>
      <div class="peak-record" id="peakRecord">
        <div class="peak-trophy">
          <div class="trophy-icon">üèÜ</div>
          <div class="trophy-label">Record</div>
        </div>
        <div>
          <span class="peak-db" id="peakRecordDb">--</span><span class="peak-db-unit"> dB</span>
          <div class="peak-time" id="peakRecordTime">Make some noise!</div>
        </div>
      </div>
    </div>

    <!-- Achievements (with duration) -->
    <div class="card hidden" id="achCard">
      <div class="card-title">Excitement Achievements</div>
      <div class="achievements" id="achList"></div>
    </div>

    <!-- Bar Meter -->
    <div class="card hidden" id="barCard">
      <div class="card-title">Level Meter  <span style="color:var(--gold);font-size:0.7rem;">‚ñÆ</span> = record</div>
      <div class="bar-meter">
        <div class="bar-track">
          <div class="bar-fill" id="barFill"></div>
          <div class="bar-record-marker" id="barRecordMarker" style="left:0%"></div>
          <div class="bar-peak-marker" id="barPeak"></div>
        </div>
        <div class="bar-labels">
          <span>0 dB</span><span>30</span><span>60</span><span>90</span><span>120</span><span>150 dB</span>
        </div>
      </div>
    </div>

    <!-- Waveform -->
    <div class="card hidden" id="waveCard">
      <div class="card-title">Live Waveform</div>
      <canvas id="waveCanvas" width="1400" height="240"></canvas>
    </div>

    <!-- Excitement Moments Log -->
    <div class="card hidden" id="momentsCard">
      <div class="card-title">Top Excitement Moments</div>
      <div class="moments-list" id="momentsList">
        <div class="no-moments">Hit "üìå Log Moment" during peaks to capture what the audience is reacting to!</div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card hidden" id="statsCard">
      <div class="card-title">Session Statistics</div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="statMin">--</div>
          <div class="stat-label">Min dB</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statAvg">--</div>
          <div class="stat-label">Avg dB</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statMax">--</div>
          <div class="stat-label">Max dB</div>
        </div>
      </div>
    </div>

    <!-- Guide -->
    <div class="card">
      <div class="card-title">Excitement Scale</div>
      <table class="guide-table">
        <tr><td><span class="guide-dot" style="background:var(--green)"></span>Calm / Quiet</td><td class="guide-db">0 ‚Äì 30 dB</td></tr>
        <tr><td><span class="guide-dot" style="background:var(--green)"></span>Light Chatter</td><td class="guide-db">30 ‚Äì 60 dB</td></tr>
        <tr><td><span class="guide-dot" style="background:var(--yellow)"></span>Engaged Crowd</td><td class="guide-db">60 ‚Äì 80 dB</td></tr>
        <tr><td><span class="guide-dot" style="background:var(--orange)"></span>Excited!</td><td class="guide-db">80 ‚Äì 100 dB</td></tr>
        <tr><td><span class="guide-dot" style="background:var(--red)"></span>Going Wild!</td><td class="guide-db">100 ‚Äì 120 dB</td></tr>
        <tr><td><span class="guide-dot" style="background:#dc2626"></span>OFF THE CHARTS!</td><td class="guide-db">120 ‚Äì 150 dB</td></tr>
      </table>
    </div>
  </div>

  <script>
    const MAX_DB = 150;

    // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
    const startBtn        = document.getElementById('startBtn');
    const logMomentBtn    = document.getElementById('logMomentBtn');
    const snapshotBtn     = document.getElementById('snapshotBtn');
    const btnText         = document.getElementById('btnText');
    const gaugeCard       = document.getElementById('gaugeCard');
    const peakCard        = document.getElementById('peakCard');
    const achCard         = document.getElementById('achCard');
    const barCard         = document.getElementById('barCard');
    const waveCard        = document.getElementById('waveCard');
    const momentsCard     = document.getElementById('momentsCard');
    const statsCard       = document.getElementById('statsCard');
    const dbValue         = document.getElementById('dbValue');
    const dbLabel         = document.getElementById('dbLabel');
    const barFill         = document.getElementById('barFill');
    const barPeak         = document.getElementById('barPeak');
    const barRecordMarker = document.getElementById('barRecordMarker');
    const statMin         = document.getElementById('statMin');
    const statAvg         = document.getElementById('statAvg');
    const statMax         = document.getElementById('statMax');
    const peakRecordDb    = document.getElementById('peakRecordDb');
    const peakRecordTime  = document.getElementById('peakRecordTime');
    const peakRecord      = document.getElementById('peakRecord');
    const achList         = document.getElementById('achList');
    const momentsList     = document.getElementById('momentsList');

    const gaugeCanvas = document.getElementById('gaugeCanvas');
    const gaugeCtx    = gaugeCanvas.getContext('2d');
    const waveCanvas  = document.getElementById('waveCanvas');
    const waveCtx     = waveCanvas.getContext('2d');

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let audioCtx, analyser, source, stream;
    let listening = false;
    let animId;
    let peakDb = 0, peakDecay = 0;
    let currentDb = 0;
    let sessionMin = Infinity, sessionMax = -Infinity, sessionSum = 0, sessionCount = 0;
    let sessionStartTime = null;

    // All-time record
    let allTimeRecord     = parseInt(localStorage.getItem('db_record') || '0', 10);
    let allTimeRecordTime = localStorage.getItem('db_record_time') || '';

    // Moments log
    let moments = JSON.parse(localStorage.getItem('db_moments') || '[]');

    // Achievement tracking ‚Äî each tracks the duration spent above threshold
    const achievements = [
      { db: 30,  icon: 'üòä', name: 'Polite Interest',    desc: 'Audience is paying attention' },
      { db: 50,  icon: 'üëè', name: 'Solid Applause',     desc: 'Genuine clapping & chatter' },
      { db: 70,  icon: 'üéâ', name: 'Crowd Buzz',         desc: 'Room is alive with energy' },
      { db: 85,  icon: 'üî•', name: 'On Fire!',           desc: 'People are really into it' },
      { db: 100, icon: 'ü§©', name: 'Standing Ovation',   desc: 'The crowd is losing it' },
      { db: 110, icon: 'üì£', name: 'Stadium Roar',       desc: 'Deafening cheers' },
      { db: 120, icon: 'üö®', name: 'Ear Splitting',      desc: 'Threshold of pain reached' },
      { db: 130, icon: '‚úàÔ∏è', name: 'Jet Engine',         desc: 'Louder than a takeoff' },
      { db: 140, icon: 'üöÄ', name: 'Rocket Launch',      desc: 'Beyond belief' },
      { db: 150, icon: 'üí•', name: 'LEGENDARY',          desc: 'Maximum crowd excitement!' },
    ];

    // Duration tracking: how many seconds spent above each threshold
    let achDurations = JSON.parse(localStorage.getItem('db_ach_durations') || '{}');
    let achMaxStreaks = JSON.parse(localStorage.getItem('db_ach_max_streaks') || '{}');
    let achCurrentStreaks = {};
    const FRAME_DUR = 1 / 60; // approx seconds per frame

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function getLevel(db) {
      if (db < 30)  return { color: 'var(--green)',  label: 'Calm' };
      if (db < 60)  return { color: 'var(--green)',  label: 'Light Chatter' };
      if (db < 80)  return { color: 'var(--yellow)', label: 'Engaged' };
      if (db < 100) return { color: 'var(--orange)', label: 'Excited!' };
      if (db < 120) return { color: 'var(--red)',    label: 'Going Wild!' };
      return { color: '#dc2626', label: 'OFF THE CHARTS!' };
    }

    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
    function timeStr() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }

    function fmtDur(sec) {
      if (sec < 1) return '<1s';
      if (sec < 60) return Math.round(sec) + 's';
      const m = Math.floor(sec / 60);
      const s = Math.round(sec % 60);
      return m + 'm ' + s + 's';
    }

    // ‚îÄ‚îÄ Render Achievements (biggest first) ‚îÄ‚îÄ
    function renderAchievements() {
      achList.innerHTML = '';
      [...achievements].reverse().forEach(a => {
        const hit = allTimeRecord >= a.db;
        const totalDur = achDurations[a.db] || 0;
        const maxStreak = achMaxStreaks[a.db] || 0;
        const row = document.createElement('div');
        row.className = 'ach-row' + (hit ? ' achieved' : '');
        row.innerHTML = `
          <div class="ach-icon">${a.icon}</div>
          <div class="ach-info">
            <div class="ach-name">${a.name}</div>
            <div class="ach-desc">${a.desc}</div>
          </div>
          <div class="ach-right">
            <div class="ach-target">${a.db} dB</div>
            ${hit ? `<div class="ach-duration">Total: ${fmtDur(totalDur)} | Best: ${fmtDur(maxStreak)}</div>` : ''}
          </div>
          <div class="ach-check">${hit ? '‚úÖ' : '‚¨ú'}</div>
        `;
        achList.appendChild(row);
      });
    }

    // ‚îÄ‚îÄ Render Moments ‚îÄ‚îÄ
    function renderMoments() {
      momentsList.innerHTML = '';
      if (moments.length === 0) {
        momentsList.innerHTML = '<div class="no-moments">Hit "üìå Log Moment" during peaks to capture what the audience is reacting to!</div>';
        return;
      }
      const sorted = [...moments].sort((a, b) => b.db - a.db);
      sorted.forEach((m, i) => {
        const rankClass = i === 0 ? 'r1' : i === 1 ? 'r2' : i === 2 ? 'r3' : '';
        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
        const level = getLevel(m.db);
        const row = document.createElement('div');
        row.className = 'moment-row';

        if (m.editing) {
          row.innerHTML = `
            <span class="moment-rank ${rankClass}">${medal}</span>
            <span class="moment-db" style="color:${level.color}">${m.db} dB</span>
            <input class="moment-input" type="text" placeholder="What happened?" value="${m.label || ''}" data-idx="${moments.indexOf(m)}" />
            <button class="moment-save-btn" data-idx="${moments.indexOf(m)}">Save</button>
            <span class="moment-time">${m.time}</span>
          `;
        } else {
          row.innerHTML = `
            <span class="moment-rank ${rankClass}">${medal}</span>
            <span class="moment-db" style="color:${level.color}">${m.db} dB</span>
            <span class="moment-dur">${fmtDur(m.duration || 0)}</span>
            <span class="moment-label">${m.label || '(unnamed moment)'}</span>
            <span class="moment-time">${m.time}</span>
          `;
        }
        momentsList.appendChild(row);
      });

      // Attach save handlers
      momentsList.querySelectorAll('.moment-save-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx, 10);
          const input = momentsList.querySelector(`input[data-idx="${idx}"]`);
          if (input) {
            moments[idx].label = input.value || '(unnamed moment)';
            moments[idx].editing = false;
            localStorage.setItem('db_moments', JSON.stringify(moments));
            renderMoments();
          }
        });
      });
      momentsList.querySelectorAll('.moment-input').forEach(input => {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const idx = parseInt(input.dataset.idx, 10);
            moments[idx].label = input.value || '(unnamed moment)';
            moments[idx].editing = false;
            localStorage.setItem('db_moments', JSON.stringify(moments));
            renderMoments();
          }
        });
      });
    }

    // ‚îÄ‚îÄ Log Moment button ‚îÄ‚îÄ
    logMomentBtn.addEventListener('click', () => {
      if (!listening) return;
      const elapsed = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 1000) : 0;
      moments.push({
        db: currentDb,
        time: timeStr(),
        elapsed,
        duration: achCurrentStreaks[Math.floor(currentDb / 10) * 10] || 0,
        label: '',
        editing: true,
      });
      localStorage.setItem('db_moments', JSON.stringify(moments));
      renderMoments();
      // Focus the new input
      setTimeout(() => {
        const inputs = momentsList.querySelectorAll('.moment-input');
        if (inputs.length) inputs[inputs.length - 1].focus();
      }, 50);
    });

    // ‚îÄ‚îÄ Update Record ‚îÄ‚îÄ
    function checkRecord(db) {
      if (db <= 0) return;

      if (db > allTimeRecord) {
        allTimeRecord = db;
        allTimeRecordTime = timeStr();
        localStorage.setItem('db_record', String(allTimeRecord));
        localStorage.setItem('db_record_time', allTimeRecordTime);

        peakRecord.classList.remove('flash');
        void peakRecord.offsetWidth;
        peakRecord.classList.add('flash');
        peakCard.classList.remove('flash-card');
        void peakCard.offsetWidth;
        peakCard.classList.add('flash-card');

        renderAchievements();
      }

      peakRecordDb.textContent = allTimeRecord;
      peakRecordTime.textContent = allTimeRecordTime ? `Set at ${allTimeRecordTime}` : 'Make some noise!';
      barRecordMarker.style.left = ((allTimeRecord / MAX_DB) * 100) + '%';
    }

    // ‚îÄ‚îÄ Update Achievement Durations ‚îÄ‚îÄ
    function updateAchDurations(db) {
      achievements.forEach(a => {
        if (db >= a.db) {
          // Increment total duration
          achDurations[a.db] = (achDurations[a.db] || 0) + FRAME_DUR;
          // Increment current streak
          achCurrentStreaks[a.db] = (achCurrentStreaks[a.db] || 0) + FRAME_DUR;
          // Track max streak
          if ((achCurrentStreaks[a.db] || 0) > (achMaxStreaks[a.db] || 0)) {
            achMaxStreaks[a.db] = achCurrentStreaks[a.db];
          }
        } else {
          // Reset current streak
          achCurrentStreaks[a.db] = 0;
        }
      });
      // Persist occasionally (every ~2 seconds)
      if (sessionCount % 120 === 0) {
        localStorage.setItem('db_ach_durations', JSON.stringify(achDurations));
        localStorage.setItem('db_ach_max_streaks', JSON.stringify(achMaxStreaks));
      }
    }

    // ‚îÄ‚îÄ Gauge Drawing ‚îÄ‚îÄ
    function drawGauge(db) {
      const W = gaugeCanvas.width;
      const H = gaugeCanvas.height;
      const cx = W / 2;
      const cy = H - 20;
      const radius = Math.min(cx, cy) - 30;

      gaugeCtx.clearRect(0, 0, W, H);

      const startAngle = Math.PI;
      const segments = [
        { end: 0.20, color: '#22c55e' },
        { end: 0.40, color: '#84cc16' },
        { end: 0.53, color: '#eab308' },
        { end: 0.67, color: '#f97316' },
        { end: 0.80, color: '#ef4444' },
        { end: 1.00, color: '#dc2626' },
      ];

      let prevFrac = 0;
      segments.forEach(seg => {
        gaugeCtx.beginPath();
        gaugeCtx.arc(cx, cy, radius, startAngle + prevFrac * Math.PI, startAngle + seg.end * Math.PI);
        gaugeCtx.lineWidth = 22;
        gaugeCtx.strokeStyle = seg.color;
        gaugeCtx.lineCap = 'butt';
        gaugeCtx.globalAlpha = 0.25;
        gaugeCtx.stroke();
        prevFrac = seg.end;
      });

      const fraction = clamp(db / MAX_DB, 0, 1);
      prevFrac = 0;
      segments.forEach(seg => {
        if (fraction > prevFrac) {
          gaugeCtx.beginPath();
          gaugeCtx.arc(cx, cy, radius, startAngle + prevFrac * Math.PI, startAngle + Math.min(fraction, seg.end) * Math.PI);
          gaugeCtx.lineWidth = 22;
          gaugeCtx.strokeStyle = seg.color;
          gaugeCtx.globalAlpha = 1;
          gaugeCtx.stroke();
        }
        prevFrac = seg.end;
      });

      gaugeCtx.globalAlpha = 1;

      for (let i = 0; i <= 15; i++) {
        const angle = startAngle + (i / 15) * Math.PI;
        const isMajor = i % 3 === 0;
        const innerR = radius - (isMajor ? 32 : 26);
        const outerR = radius - 16;
        gaugeCtx.beginPath();
        gaugeCtx.moveTo(cx + innerR * Math.cos(angle), cy + innerR * Math.sin(angle));
        gaugeCtx.lineTo(cx + outerR * Math.cos(angle), cy + outerR * Math.sin(angle));
        gaugeCtx.strokeStyle = isMajor ? '#94a3b8' : '#475569';
        gaugeCtx.lineWidth = isMajor ? 2 : 1;
        gaugeCtx.stroke();
        if (isMajor) {
          const labelR = innerR - 14;
          gaugeCtx.fillStyle = '#94a3b8';
          gaugeCtx.font = '600 13px system-ui';
          gaugeCtx.textAlign = 'center';
          gaugeCtx.textBaseline = 'middle';
          gaugeCtx.fillText(String(i * 10), cx + labelR * Math.cos(angle), cy + labelR * Math.sin(angle));
        }
      }

      // Record marker
      if (allTimeRecord > 0) {
        const recAngle = startAngle + (allTimeRecord / MAX_DB) * Math.PI;
        gaugeCtx.beginPath();
        gaugeCtx.arc(cx + (radius + 2) * Math.cos(recAngle), cy + (radius + 2) * Math.sin(recAngle), 5, 0, Math.PI * 2);
        gaugeCtx.fillStyle = '#fbbf24';
        gaugeCtx.shadowColor = 'rgba(251,191,36,0.6)';
        gaugeCtx.shadowBlur = 10;
        gaugeCtx.fill();
        gaugeCtx.shadowBlur = 0;
      }

      // Needle
      const needleAngle = startAngle + fraction * Math.PI;
      gaugeCtx.save();
      gaugeCtx.translate(cx, cy);
      gaugeCtx.rotate(needleAngle);
      gaugeCtx.beginPath();
      gaugeCtx.moveTo(0, -3);
      gaugeCtx.lineTo(radius - 38, 0);
      gaugeCtx.lineTo(0, 3);
      gaugeCtx.closePath();
      gaugeCtx.fillStyle = '#f8fafc';
      gaugeCtx.shadowColor = 'rgba(255,255,255,0.3)';
      gaugeCtx.shadowBlur = 8;
      gaugeCtx.fill();
      gaugeCtx.restore();

      gaugeCtx.beginPath();
      gaugeCtx.arc(cx, cy, 7, 0, Math.PI * 2);
      gaugeCtx.fillStyle = '#e2e8f0';
      gaugeCtx.fill();
    }

    // ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ
    function drawWaveform(dataArray) {
      const W = waveCanvas.width, H = waveCanvas.height;
      waveCtx.clearRect(0, 0, W, H);
      const grad = waveCtx.createLinearGradient(0, 0, W, 0);
      grad.addColorStop(0, '#3b82f6');
      grad.addColorStop(0.5, '#a78bfa');
      grad.addColorStop(1, '#3b82f6');
      waveCtx.beginPath();
      const sw = W / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const y = (dataArray[i] / 128.0 * H) / 2;
        i === 0 ? waveCtx.moveTo(x, y) : waveCtx.lineTo(x, y);
        x += sw;
      }
      waveCtx.strokeStyle = grad;
      waveCtx.lineWidth = 2;
      waveCtx.stroke();
      waveCtx.globalAlpha = 0.3;
      waveCtx.stroke();
      waveCtx.globalAlpha = 1;
    }

    // ‚îÄ‚îÄ Main Loop ‚îÄ‚îÄ
    function loop() {
      if (!listening) return;

      const dataArray = new Float32Array(analyser.fftSize);
      analyser.getFloatTimeDomainData(dataArray);

      let sumSq = 0;
      for (let i = 0; i < dataArray.length; i++) sumSq += dataArray[i] * dataArray[i];
      const rms = Math.sqrt(sumSq / dataArray.length);
      let db = rms > 0.000001 ? 20 * Math.log10(rms) + 110 : 0;
      db = clamp(Math.round(db), 0, MAX_DB);
      currentDb = db;

      if (db > peakDb) { peakDb = db; peakDecay = 0; }
      else { peakDecay++; if (peakDecay > 40) peakDb = Math.max(peakDb - 0.5, db); }

      if (db > 0) {
        sessionMin = Math.min(sessionMin, db);
        sessionMax = Math.max(sessionMax, db);
        sessionSum += db;
        sessionCount++;
      }

      checkRecord(db);
      updateAchDurations(db);

      // Render achievements every ~1s
      if (sessionCount % 60 === 0) renderAchievements();

      const level = getLevel(db);
      dbValue.textContent = db;
      dbValue.style.color = level.color;
      dbLabel.textContent = level.label;
      dbLabel.style.color = level.color;

      barFill.style.width = (db / MAX_DB * 100) + '%';
      barPeak.style.left = (peakDb / MAX_DB * 100) + '%';

      drawGauge(db);

      const waveData = new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(waveData);
      drawWaveform(waveData);

      if (sessionCount > 0) {
        statMin.textContent = sessionMin === Infinity ? '--' : sessionMin;
        statAvg.textContent = Math.round(sessionSum / sessionCount);
        statMax.textContent = sessionMax === -Infinity ? '--' : sessionMax;
      }

      animId = requestAnimationFrame(loop);
    }

    // ‚îÄ‚îÄ Start / Stop ‚îÄ‚îÄ
    async function startListening() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
        });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 4096;
        analyser.smoothingTimeConstant = 0.2;
        analyser.minDecibels = -127;
        analyser.maxDecibels = 0;
        source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);

        listening = true;
        sessionStartTime = Date.now();
        startBtn.classList.add('listening');
        btnText.textContent = 'Stop Listening';
        logMomentBtn.style.display = 'block';
        snapshotBtn.style.display = 'block';

        [gaugeCard, peakCard, achCard, barCard, waveCard, momentsCard, statsCard].forEach(c => c.classList.remove('hidden'));

        sessionMin = Infinity; sessionMax = -Infinity; sessionSum = 0; sessionCount = 0; peakDb = 0;
        achCurrentStreaks = {};

        renderAchievements();
        renderMoments();
        checkRecord(0);
        loop();
      } catch (err) {
        alert('Microphone access is required.\n\n' + err.message);
      }
    }

    function stopListening() {
      listening = false;
      cancelAnimationFrame(animId);
      if (source) source.disconnect();
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (audioCtx) audioCtx.close();
      startBtn.classList.remove('listening');
      btnText.textContent = 'Start Listening';
      logMomentBtn.style.display = 'none';
      snapshotBtn.style.display = 'none';
      // Final persist
      localStorage.setItem('db_ach_durations', JSON.stringify(achDurations));
      localStorage.setItem('db_ach_max_streaks', JSON.stringify(achMaxStreaks));
      renderAchievements();
    }

    startBtn.addEventListener('click', () => {
      if (listening) stopListening(); else startListening();
    });

    // ‚îÄ‚îÄ Snapshot & Clear ‚îÄ‚îÄ
    snapshotBtn.addEventListener('click', () => {
      const confirmed = confirm(
        'üì∏ Snapshot & New Session\n\n' +
        'This will:\n' +
        '‚Ä¢ Save current data as a snapshot (downloaded as JSON)\n' +
        '‚Ä¢ Clear all records, achievements, and moments\n' +
        '‚Ä¢ Start fresh for a new celebration!\n\n' +
        'Continue?'
      );
      if (!confirmed) return;

      // Build snapshot
      const snapshot = {
        exportedAt: new Date().toISOString(),
        record: { db: allTimeRecord, time: allTimeRecordTime },
        achievements: achievements.map(a => ({
          name: a.name,
          db: a.db,
          achieved: allTimeRecord >= a.db,
          totalDuration: achDurations[a.db] || 0,
          bestStreak: achMaxStreaks[a.db] || 0,
        })),
        moments: moments.map(m => ({ db: m.db, time: m.time, label: m.label, duration: m.duration || 0 })),
        sessionStats: {
          min: sessionMin === Infinity ? null : sessionMin,
          avg: sessionCount > 0 ? Math.round(sessionSum / sessionCount) : null,
          max: sessionMax === -Infinity ? null : sessionMax,
        },
      };

      // Download as JSON
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'excitement-snapshot-' + new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-') + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Clear all persisted data
      allTimeRecord = 0;
      allTimeRecordTime = '';
      moments = [];
      achDurations = {};
      achMaxStreaks = {};
      achCurrentStreaks = {};
      topPeaks = [];
      localStorage.removeItem('db_record');
      localStorage.removeItem('db_record_time');
      localStorage.removeItem('db_moments');
      localStorage.removeItem('db_ach_durations');
      localStorage.removeItem('db_ach_max_streaks');
      localStorage.removeItem('db_top_peaks');

      // Reset session stats
      sessionMin = Infinity;
      sessionMax = -Infinity;
      sessionSum = 0;
      sessionCount = 0;
      peakDb = 0;

      // Re-render everything
      peakRecordDb.textContent = '--';
      peakRecordTime.textContent = 'Make some noise!';
      barRecordMarker.style.left = '0%';
      statMin.textContent = '--';
      statAvg.textContent = '--';
      statMax.textContent = '--';
      renderAchievements();
      renderMoments();
    });
  </script>
</body>
</html>
